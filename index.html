<head>
    <meta charset="utf8">
    <link rel="shortcut icon" href="/img/favicon.jpg">
    <link rel='stylesheet' href='/global.css'>
    <link rel="stylesheet" href="/main.css">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,600;0,700;0,800;1,300;1,400;1,600;1,700;1,800&display=swap"
          rel="stylesheet">
    <title>Postia</title>
</head>


<label class="flex-column">
    <input name="post" type="file">
</label>


<script>
    const inputFile = document.querySelector('input[type=file]')

    inputFile.oninput = (e) => {
        const reader = new FileReader();
        reader.readAsDataURL(e.target.files[0]);
        reader.onload = () => {
            const res = reader.result;
            window.res = res;
            document.querySelector('.image img').src = res;
        };
    }

</script>

<div class="align-items-start">
    <div class="image">
        <img src="mmm.jpg">
        <div class="text-block" style="left: 58px; top: 112px; align-items: flex-start; font-size: 46px;">
            <div class="line editable-div">
                текст
            </div>
        </div>
    </div>
    <div>
        <label class="flex-column">
            резмер текста
            <input class="input-font-size" type="number" value="46">
        </label>


        <div>
            <button class="btn-align" data-align="flex-start">
                start
            </button>
            <button class="btn-align" data-align="center">
                center
            </button>
            <button class="btn-align" data-align="flex-end">
                end
            </button>
        </div>


        <div>
            <button class="btn-clean">
                clean
            </button>
            <button class="btn-apply">
                apply
            </button>
        </div>


        <div class="editable-div" contenteditable="true">
            Этот текст может быть отредактирован пользователем.
        </div>

        <div class="smile-piker">
            <img class="smile-icon" src="emojipedia/apple/0000.jpg">
        </div>


    </div>
</div>


<script>
    const createLine = () => Object.assign(document.createElement('div'), {
        className: 'line editable-div',
    });

    const insertAfter = (newElem, refElem) => {
        const nextNode = refElem.nextElementSibling;
        console.log('nextNode');
        console.log(nextNode);
        if (nextNode) {
            console.log('before');
            nextNode.parentElement.insertBefore(newElem, refElem);
        } else {
            console.log('append');
            refElem.parentElement.appendChild(newElem);
        }
        return newElem;
    }

    const doDirt = () => {

        ((onkeydown) => {
            document.querySelectorAll('.line.editable-div').forEach((selectElem) => {
                selectElem.onkeydown = onkeydown;
            });
        })((e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const div = e.target;
                console.log(div)
                console.log(div)
                console.log(div)
                const line = createLine();
                insertAfter(line, div);
                doDirt();
                line.focus();
            }
        });


        ((oninput) => {
            document.querySelectorAll('.line.editable-div').forEach((selectElem) => {
                selectElem.oninput = oninput;
            });
        })((e) => {
            const div = e.target;
            console.log(e)
        });


    }
    doDirt();

    const smilePiker = document.querySelector('.smile-piker');


    (() => {
        smilePiker.textContent = '';
        for (let i = 0; i < 3175; i++) {
            const img = document.createElement('img')
            img.className = "smile-icon";
            const imgBaseName = "000000".concat(i.toString()).slice(-4);
            img.src = 'emojipedia/apple/' + imgBaseName + '.jpg';
            smilePiker.appendChild(img);
        }
    })()

    smilePiker.onclick = (e) => {
        const smile = Object.assign(document.createElement('img'), {
            className: 'smile',
            src: e.target.src
        })
        // editableDiv.appendChild(img);
        pasteSmile(smile)
    }


</script>


<button class="btn-download">
    download
</button>


<script>
    const editableDiv = document.body.querySelector('.editable-div');

    const pasteSmile = (smile) => {
        const selection = window.getSelection()
        const anchorNode = selection.anchorNode;

        if (isTextNode(anchorNode)) {
            const textNodeAfter = document.createTextNode(anchorNode.textContent.substr(selection.anchorOffset));
            anchorNode.textContent = anchorNode.textContent.substr(0, selection.anchorOffset);
            insertAfter(smile, anchorNode);
            insertAfter(textNodeAfter, smile);
            // todo selection
        } else {
            if (anchorNode.classList.contains('line')) {
                anchorNode.appendChild(smile);
            } else {
                console.error(anchorNode);
                throw 'WTF';
            }
        }
    }


    const clean = () => {
        for (const elem of editableDiv.children) {
            if (elem.tagName.toLowerCase() === 'img') {
                elem.removeAttribute('style')
                continue;
            }

            if (elem.tagName.toLowerCase() === 'div') {
                elem.removeAttribute('class')
                elem.removeAttribute('style')
                for (const innerElem of elem.children) {
                    if (innerElem.tagName.toLowerCase() === 'img') {
                        innerElem.removeAttribute('style')
                        continue;
                    }
                    console.log(innerElem)
                    elem.insertBefore(document.createTextNode(innerElem.textContent), innerElem)
                    innerElem.remove();
                }
                continue;
            }

            editableDiv.insertBefore(document.createTextNode(elem.textContent), elem)
            elem.remove();
        }
        editableDiv.normalize()
    }


    const apply = () => {
        const lines = [[]];

        let lastIsNode = true;
        for (const node of editableDiv.childNodes) {
            if (isTextNode(node)) {
                if (lastIsNode) {
                    lines[lines.length - 1].push(node.cloneNode(true))
                } else {
                    lines.push([node.cloneNode(true)])
                    lastIsNode = true;
                }
            } else {
                lastIsNode = false;
                if (node.tagName.toLowerCase() === 'img') {
                    lines[0].push(node.cloneNode(true))
                } else {
                    lines.push(Array.from(node.cloneNode(true).childNodes))
                }
            }
        }
        apply2(lines)

    }


    const isTextNode = (node) => {
        switch (node.nodeType) {
            case 3: // text node
                return true;
            case 1: // element
                return false;
            default:
                console.error(node);
                throw 'not a text or element node';
        }
    }


    const apply2 = (lines) => {
        const textBlock = document.querySelector('.text-block');
        textBlock.textContent = "";
        for (const line of lines) {
            const lineDiv = Object.assign(document.createElement('div'), {
                className: 'line'
            });
            for (const el of line) {
                lineDiv.appendChild(el);
            }
            textBlock.appendChild(lineDiv)
        }
        console.log(lines)
    }


    document.querySelector('.btn-clean').onclick = clean;
    document.querySelector('.btn-apply').onclick = apply;

    const targetDiv = document.body.querySelector('.image');

    /*
    https://emojipedia.org/apple/
    https://emojipedia.org/twitter/twemoji-13.0.1/
     */

    document.querySelector('.btn-download').onclick = () => {
        window.scrollTo(0, 0);
        html2canvas(targetDiv, {
            windowWidth: targetDiv.scrollWidth,
            windowHeight: targetDiv.scrollHeight
        }).then((canvas) => {
            const link = document.createElement('a');
            link.download = 'result.jpg';
            link.href = canvas.toDataURL('image/jpeg', 1.0)
            link.click();
        });
    }


    const textBlock = document.querySelector('.text-block');


    ((func) => {
        document.querySelectorAll('.btn-align').forEach(elem => {
            elem.onclick = func;
        })
    })((e) => {
        textBlock.style.alignItems = e.target.getAttribute('data-align')
    })


    document.querySelector('.input-font-size').oninput = (e) => {
        textBlock.style.fontSize = parseInt(e.target.value, 10).toString().concat('px')
    }

    ((onmousewheel) => {
        const passive = {passive: false};
        [document.querySelector('.input-font-size')].forEach((selectElem) => {
            if (selectElem) {
                selectElem.addEventListener('mousewheel', onmousewheel, passive);
            }
        });
    })((e) => {
        e.preventDefault();
        const input = e.target;
        const value = parseInt(input.value, 10) || 10;
        const newValue = value + ((e.deltaY < 0) ? -1 : 1);
        input.value = (newValue < 10) ? '10' : newValue.toString();
        input.oninput(e);
    });


    /**
     * @param {MouseEvent} e
     */
    textBlock.onmousedown = (e) => {
        console.log(e)
        const style = window.getComputedStyle(textBlock);
        const shiftX = e.x - parseInt(style.left, 10);
        const shiftY = e.y - parseInt(style.top, 10);

        document.onmousemove = (e) => {
            console.log(e)
            textBlock.style.left = (e.x - shiftX).toString() + 'px';
            textBlock.style.top = (e.y - shiftY).toString() + 'px';
        }

        document.onmouseup = () => {
            document.onmouseup = null;
            document.onmousemove = null;
        }
    }

</script>


<script src="html2canvas.js"></script>


<div class="flex-column">
    <a href="https://www.instagram.com/explore/tags/blueberrysmoothie/">inst blueberrysmoothie</a>
    <a href="https://sevelina.ru/soveti-dlia-devochek/kak-spravitsya-s-volneniem/">Как справиться с волнением</a>
    <a href="https://sevelina.ru/category/soveti-dlia-devochek/">Советы для девочек</a>
    <span>Околоцелевая фигня:</span>
    <a href="https://www.instagram.com/universal_fakt/">https://www.instagram.com/universal_fakt/</a>
    <a href="https://www.instagram.com/brina.nailz/">Сойдет как сохры</a>
</div>